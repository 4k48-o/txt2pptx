<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLY AI - PPT Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义主题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#f3f4f6',
                        accent: '#8b5cf6',
                        neutral: '#f9fafb',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 2px 15px 0 rgba(0, 0, 0, 0.05)',
                    }
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none;
            }
            .card-hover {
                @apply hover:shadow-md hover:-translate-y-1 transition-all duration-200;
            }
        }
        
        /* 时间轴样式 */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 0.25rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background: #2563eb;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #2563eb;
        }
        
        .timeline-item.completed::before {
            background: #10b981;
            box-shadow: 0 0 0 2px #10b981;
        }
        
        .timeline-item.error::before {
            background: #ef4444;
            box-shadow: 0 0 0 2px #ef4444;
        }
        
        .timeline-item.progress::before {
            background: #8b5cf6; /* purple-500 */
            box-shadow: 0 0 0 2px #8b5cf6;
            animation: pulse 2s infinite;
        }
        
        /* 执行中的呼吸光影效果 - 只应用于最新的 progress 项 */
        .timeline-item.progress.active > div {
            position: relative;
            overflow: hidden;
            animation: breathe 2s ease-in-out infinite;
        }
        
        .timeline-item.progress.active > div::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(139, 92, 246, 0.1),
                rgba(139, 92, 246, 0.2),
                rgba(139, 92, 246, 0.1)
            );
            border-radius: 0.5rem; /* 与 rounded-lg 保持一致 */
            animation: breathe-glow 2s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes breathe {
            0%, 100% {
                box-shadow: 0 0 5px rgba(139, 92, 246, 0.2),
                            0 0 10px rgba(139, 92, 246, 0.15),
                            0 0 15px rgba(139, 92, 246, 0.1);
            }
            50% {
                box-shadow: 0 0 10px rgba(139, 92, 246, 0.4),
                            0 0 20px rgba(139, 92, 246, 0.3),
                            0 0 30px rgba(139, 92, 246, 0.2);
            }
        }
        
        @keyframes breathe-glow {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        /* 左侧内容区域动画 */
        .left-content-area {
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1 1 100%;
            min-width: 0;
        }
        
        .left-content-area.compact {
            flex: 1 1 66.666667%; /* 2/3 宽度 */
        }
        
        /* 左侧内容内部区域，初始居中，compact 后左对齐 */
        #leftContentInner {
            transition: margin 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: auto;
            margin-right: auto;
        }
        
        .left-content-area.compact #leftContentInner {
            margin-left: 0;
            margin-right: 0;
        }
        
        /* Activity Timeline 面板动画 */
        .timeline-panel {
            flex: 0 0 0;
            transform: translateX(100%);
            opacity: 0;
            overflow: hidden;
            transition: flex 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .timeline-panel.show {
            flex: 0 0 33.333333%; /* 1/3 宽度 */
            transform: translateX(0);
            opacity: 1;
        }
        
        /* 移动端：从下方滑入 */
        @media (max-width: 1024px) {
            .left-content-area.compact {
                flex: 1 1 100%;
            }
            
            .timeline-panel {
                flex: 0 0 0;
                transform: translateY(100%);
                max-height: 0;
            }
            
            .timeline-panel.show {
                flex: 0 0 auto;
                transform: translateY(0);
                max-height: 1000px;
            }
        }
    </style>
</head>
<body class="bg-neutral font-sans text-gray-800 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-soft py-4 px-6 md:px-12 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="static/logo/logo.png" alt="DLY AI" class="h-8 w-auto" />
            <span class="text-lg font-semibold text-gray-800">DLY AI</span>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <span class="text-gray-500 text-sm">1,640</span>
                <i class="fa fa-bolt text-yellow-500"></i>
            </div>
            <a href="tasks" class="text-gray-600 hover:text-gray-900 text-sm">Tasks</a>
            <div class="w-8 h-8 rounded-full bg-gray-300 overflow-hidden">
                <img src="https://picsum.photos/200/200" alt="User avatar" class="w-full h-full object-cover">
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="max-w-7xl mx-auto px-6 md:px-12 py-12">
        <!-- 标题区域 -->
        <div class="text-center mb-10">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold bg-gradient-to-r from-purple-500 to-purple-600 bg-clip-text text-transparent mb-4" style="text-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);">What can I create for you?</h1>
            <div class="inline-flex items-center gap-2 bg-secondary px-4 py-2 rounded-full">
                <span class="text-gray-600 text-sm">Free Plan</span>
                <span class="text-sm font-medium bg-gradient-to-r from-purple-500 to-purple-600 bg-clip-text text-transparent">Start Free Trial</span>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 relative">
            <!-- 左侧：输入区域 -->
            <div id="leftContentArea" class="left-content-area">
                <!-- 核心输入区域 -->
                <div class="max-w-4xl mb-8" id="leftContentInner">
                    <!-- 描述输入框 -->
                    <div class="bg-white rounded-2xl shadow-soft p-1 mb-4">
                        <textarea 
                            id="promptInput"
                            placeholder="Describe your project theme..." 
                            class="w-full px-4 py-6 text-lg border-0 resize-none input-focus rounded-2xl h-32"
                        ></textarea>
                    </div>
                    <!-- 错误消息显示区域 -->
                    <div id="promptError" class="hidden mb-4">
                        <p class="text-sm text-red-500 flex items-center gap-1">
                            <i class="fa fa-exclamation-circle"></i>
                            <span>Please enter a project description</span>
                        </p>
                    </div>
                    
                    <!-- PPT 配置选项 -->
                    <div class="bg-white rounded-2xl shadow-soft p-6 mb-4">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900">Presentation Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- 页数选择 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fa fa-file-text mr-1"></i> Slides
                                </label>
                                <div class="relative">
                                    <select id="slidesSelect" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm input-focus bg-white appearance-none">
                                        <option value="1">1 slide (Minimal)</option>
                                        <option value="3">3 slides (Brief)</option>
                                        <option value="5" selected>5 slides (Standard)</option>
                                        <option value="8">8 slides (Detailed)</option>
                                        <option value="10">10 slides (Comprehensive)</option>
                                    </select>
                                    <i class="fa fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                                </div>
                            </div>
                            
                            <!-- 样式选择 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fa fa-tint mr-1"></i> Style
                                </label>
                                <div class="relative">
                                    <select id="styleSelect" class="w-full px-3 py-2 pl-8 pr-8 border border-gray-300 rounded-lg text-sm input-focus bg-white appearance-none">
                                        <option value="professional">Professional</option>
                                        <option value="modern" selected>Modern</option>
                                        <option value="creative">Creative</option>
                                        <option value="academic">Academic</option>
                                        <option value="tech">Tech</option>
                                        <option value="elegant">Elegant</option>
                                    </select>
                                    <i id="styleSelectIcon" class="fa fa-star absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none"></i>
                                    <i class="fa fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                                </div>
                            </div>
                            
                            <!-- 目标人群 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fa fa-users mr-1"></i> Audience
                                </label>
                                <div class="relative">
                                    <select id="audienceSelect" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm input-focus bg-white appearance-none">
                                        <option value="general">General Public</option>
                                        <option value="executives" selected>Executives</option>
                                        <option value="students">Students</option>
                                        <option value="developers">Developers</option>
                                        <option value="investors">Investors</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <i class="fa fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 自定义人群输入 -->
                        <div id="customAudienceInput" class="mt-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Audience</label>
                            <input 
                                type="text" 
                                id="customAudienceText"
                                placeholder="e.g., Enterprise CTOs, Marketing Directors..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm input-focus"
                            >
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="flex justify-end gap-3">
                        <button 
                            id="generateBtn"
                            onclick="generatePPT()"
                            class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-medium hover:from-purple-600 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                        >
                            <i class="fa fa-rocket"></i>
                            <span id="generateBtnText">Generate PPT</span>
                        </button>
                    </div>

                    <!-- 示例提示词区域 -->
                    <div class="mb-8">
                        <div class="flex items-center gap-2 mb-4">
                            <h2 class="text-lg font-semibold">Example Prompts</h2>
                            <button 
                                id="refreshPromptsBtn"
                                onclick="refreshExamplePrompts()"
                                class="flex items-center gap-1 px-2 py-1 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="刷新提示词"
                            >
                                <i class="fa fa-refresh"></i>
                            </button>
                        </div>
                        <div id="examplePromptsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- 提示词将通过 JavaScript 动态渲染 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：时间轴和状态 -->
            <div id="timelinePanel" class="bg-white rounded-2xl shadow-soft p-6 sticky top-4 timeline-panel">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900">
                        <i class="fa fa-clock-o mr-2"></i>Activity Timeline
                    </h3>
                    
                    <!-- WebSocket 连接状态 -->
                    <div id="wsStatus" class="mb-4 p-3 rounded-lg bg-gray-50 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-gray-400" id="wsIndicator"></div>
                        <span class="text-sm text-gray-600" id="wsStatusText">Connecting...</span>
                    </div>
                    
                    <!-- 时间轴容器 -->
                    <div id="timelineContainer" class="timeline min-h-[200px]">
                        <div class="text-center text-gray-400 text-sm py-8" id="emptyTimeline">
                            No activity yet. Start generating to see progress.
                        </div>
                    </div>
                    
                    <!-- 下载按钮（完成后显示） -->
                    <div id="downloadSection" class="mt-4 hidden">
                        <button 
                            id="downloadBtn"
                            onclick="downloadPPT()"
                            class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-medium hover:from-purple-600 hover:to-purple-700 transition-all shadow-lg"
                        >
                            <i class="fa fa-download"></i>
                            <span>Download PPT</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white mt-20 py-8 px-6 md:px-12 border-t border-gray-100">
        <div class="max-w-7xl mx-auto text-center text-sm text-gray-500">
            <p>© 2026 DLY AI. All rights reserved.</p>
        </div>
    </footer>

    <!-- Mock 数据脚本（用于前端调试，添加时间戳避免缓存） -->
    <script>
        // 动态加载 mock-data.js，添加文件修改时间戳确保获取最新版本
        // 时间戳：1768535296 (文件修改时间，修改文件后需要更新此值)
        (function() {
            const script = document.createElement('script');
            // 使用文件修改时间戳作为版本号，修改文件后更新此值
            const appBase = window.location.pathname.startsWith('/menus') ? '/menus' : '';
            script.src = `${appBase}/static/mock-data.js?v=2768535296`;
            script.async = false;
            document.head.appendChild(script);
        })();
    </script>
    
    <script>
        // /menus 子路径部署适配：自动推断 base path
        const APP_BASE = window.location.pathname.startsWith('/menus') ? '/menus' : '';
        const API_BASE = `${APP_BASE}/api`;
        let currentTaskId = null;
        let clientId = null;
        let ws = null;
        let wsReconnectTimer = null;
        let mockMode = false; // 是否启用 Mock 模式
        
        // Mock 模式开关（通过 URL 参数 ?mock=true 启用）
        // 例如：http://localhost:8000/?mock=true
        const urlParams = new URLSearchParams(window.location.search);
        const USE_MOCK_DATA = urlParams.get('mock') === 'true';
        
        // 调试：输出 Mock 模式状态
        console.log('[App] Mock 模式状态:', USE_MOCK_DATA, 'URL参数:', window.location.search);
        
        // Mock 数据生成器（基于真实后台日志）
        // 真实时间间隔：0s, 2s, 8s, 28s, 178s(2.98min), 188s(3.13min)
        // 测试时缩短为：0s, 0.5s, 2s, 5s, 8s, 10s
        const mockMessages = [
            {
                type: 'connected',
                timestamp: new Date().toISOString(),
                delay: 0
            },
            {
                type: 'task_created',
                task_id: 'QqxM2dk9pVHxNGBTSqLoAe',
                local_task_id: 'e57e342f-ee5f-4240-8396-ccb09e77f612',
                title: 'Cybersecurity Training Module for Executives',
                task_url: 'https://manus.im/app/QqxM2dk9pVHxNGBTSqLoAe',
                message: '任务已创建，正在处理中...',
                delay: 500 // 0.5秒后发送（真实：2秒）
            },
            {
                type: 'task_progress',
                task_id: 'QqxM2dk9pVHxNGBTSqLoAe',
                message: 'Prepare slide content for cybersecurity training module',
                delay: 2000 // 2秒后发送（真实：8秒）
            },
            {
                type: 'task_progress',
                task_id: 'QqxM2dk9pVHxNGBTSqLoAe',
                message: 'Generate slides presentation',
                delay: 5000 // 5秒后发送（真实：28秒）
            },
            {
                type: 'task_progress',
                task_id: 'QqxM2dk9pVHxNGBTSqLoAe',
                message: 'Deliver final presentation to user',
                delay: 8000 // 8秒后发送（真实：178秒）
            },
            {
                type: 'task_completed',
                task_id: 'QqxM2dk9pVHxNGBTSqLoAe',
                local_task_id: 'e57e342f-ee5f-4240-8396-ccb09e77f612',
                title: 'Cybersecurity Training Module for Executives',
                download_url: `${API_BASE}/tasks/e57e342f-ee5f-4240-8396-ccb09e77f612/download`,
                message: 'PPT 生成完成！',
                delay: 10000 // 10秒后发送（真实：188秒）
            }
        ];
        
        // Mock 任务创建响应（如果 mock-data.js 未加载，则使用本地定义）
        let mockCreateTaskResponse;
        if (typeof window !== 'undefined' && window.mockCreateTaskResponse) {
            mockCreateTaskResponse = window.mockCreateTaskResponse;
        } else {
            mockCreateTaskResponse = {
                success: true,
                data: {
                    id: 'e57e342f-ee5f-4240-8396-ccb09e77f612',
                    status: 'running',
                    message: 'Task created, waiting for Manus webhook callback'
                },
                message: '任务创建成功，等待 Manus 处理'
            };
        }
        
        // Mock WebSocket 模拟器
        let mockTimeouts = [];
        let mockWs = null;
        
        // 初始化 Mock WebSocket 连接（只建立连接，不发送消息）
        function initMockWebSocket() {
            console.log('[Mock] 初始化 Mock WebSocket 连接...');
            updateWSStatus(true, 'Connected (Mock Mode)');
            
            // 只发送连接成功消息，不发送任务相关消息
            setTimeout(() => {
                handleWebSocketMessage({
                    type: 'connected',
                    timestamp: new Date().toISOString()
                });
            }, 100);
        }
        
        // 启动 Mock WebSocket 消息序列（在任务创建后调用）
        function startMockWebSocket(taskId) {
            console.log('[Mock] 启动 Mock WebSocket 消息序列，taskId:', taskId);
            
            // 清除之前的定时器
            stopMockWebSocket();
            
            // 创建基于实际 taskId 的 mock 消息
            const taskMockMessages = [
                {
                    type: 'task_created',
                    task_id: taskId,
                    local_task_id: taskId,
                    title: 'Cybersecurity Training Module for Executives',
                    task_url: `https://manus.im/app/${taskId}`,
                    message: '任务已创建，正在处理中...',
                    delay: 500 // 0.5秒后发送
                },
                {
                    type: 'task_progress',
                    task_id: taskId,
                    message: 'Prepare slide content for cybersecurity training module',
                    delay: 2000 // 2秒后发送
                },
                {
                    type: 'task_progress',
                    task_id: taskId,
                    message: 'Generate slides presentation',
                    delay: 5000 // 5秒后发送
                },
                {
                    type: 'task_progress',
                    task_id: taskId,
                    message: 'Deliver final presentation to user',
                    delay: 8000 // 8秒后发送
                },
                {
                    type: 'task_completed',
                    task_id: taskId,
                    local_task_id: taskId,
                    title: 'Cybersecurity Training Module for Executives',
                    download_url: `${API_BASE}/tasks/${taskId}/download`,
                    message: 'PPT 生成完成！',
                    delay: 10000 // 10秒后发送
                }
            ];
            
            // 按延迟时间发送消息
            for (let i = 0; i < taskMockMessages.length; i++) {
                const message = taskMockMessages[i];
                const delay = message.delay || 0;
                
                const timeout = setTimeout(() => {
                    const msgCopy = { ...message };
                    msgCopy.timestamp = new Date().toISOString();
                    console.log('[Mock] 发送消息:', msgCopy.type, 'taskId:', msgCopy.task_id);
                    handleWebSocketMessage(msgCopy);
                }, delay);
                
                mockTimeouts.push(timeout);
            }
            
            console.log(`[Mock] 已安排 ${taskMockMessages.length} 条消息`);
        }
        
        function stopMockWebSocket() {
            mockTimeouts.forEach(timeout => clearTimeout(timeout));
            mockTimeouts = [];
        }

        // 样式图标映射
        const styleIcons = {
            'professional': 'briefcase',
            'modern': 'star',
            'creative': 'paint-brush',
            'academic': 'graduation-cap',
            'tech': 'laptop',
            'elegant': 'heart'
        };

        // 更新样式选择框图标
        function updateStyleIcon() {
            const select = document.getElementById('styleSelect');
            const icon = document.getElementById('styleSelectIcon');
            const selectedValue = select.value;
            const iconName = styleIcons[selectedValue] || 'star';
            icon.className = `fa fa-${iconName} absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none`;
        }

        // 显示 Activity Timeline 面板（带动画）
        function showTimelinePanel() {
            const panel = document.getElementById('timelinePanel');
            const leftArea = document.getElementById('leftContentArea');
            
            if (panel && !panel.classList.contains('show')) {
                // 先缩小左侧区域
                if (leftArea) {
                    leftArea.classList.add('compact');
                }
                
                // 然后显示右侧 Timeline 面板（稍微延迟，让左侧动画先开始）
                setTimeout(() => {
                    panel.classList.add('show');
                }, 100);
            }
        }

        // 多组示例提示词
        const examplePromptsGroups = [
            [
                'Create a training module on cybersecurity best practices',
                'Build a sales presentation for B2B software solutions',
                'Design a presentation on tech impact on future jobs',
                'Create a startup pitch deck for fundraising'
            ],
            [
                'Develop a quarterly business review presentation',
                'Create an onboarding presentation for new employees',
                'Design a product launch presentation for a new app',
                'Build a financial report presentation for stakeholders'
            ],
            [
                'Create a marketing strategy presentation for Q4',
                'Design a training presentation on customer service excellence',
                'Build a project proposal presentation for a new initiative',
                'Create a company culture and values presentation'
            ],
            [
                'Develop a data analytics insights presentation',
                'Design a sustainability and ESG report presentation',
                'Create a competitive analysis presentation',
                'Build a team building and collaboration workshop presentation'
            ],
            [
                'Create a technology trends and innovation presentation',
                'Design a customer success stories presentation',
                'Build a process improvement and optimization presentation',
                'Create a leadership development program presentation'
            ]
        ];
        
        let currentPromptsGroupIndex = 0;
        
        // 渲染示例提示词
        function renderExamplePrompts() {
            const container = document.getElementById('examplePromptsContainer');
            if (!container) return;
            
            const prompts = examplePromptsGroups[currentPromptsGroupIndex];
            container.innerHTML = prompts.map(prompt => {
                // 转义单引号，避免 onclick 中的引号冲突
                const escapedPrompt = prompt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                    <div class="bg-white rounded-xl shadow-soft p-4 card-hover cursor-pointer" onclick="fillExample('${escapedPrompt}')">
                        <p class="text-gray-700 text-sm">${prompt}</p>
                    </div>
                `;
            }).join('');
        }
        
        // 刷新示例提示词（切换到下一组）
        window.refreshExamplePrompts = function() {
            currentPromptsGroupIndex = (currentPromptsGroupIndex + 1) % examplePromptsGroups.length;
            renderExamplePrompts();
            
            // 添加旋转动画
            const refreshBtn = document.getElementById('refreshPromptsBtn');
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                if (icon) {
                    icon.style.transition = 'transform 0.5s ease';
                    icon.style.transform = 'rotate(360deg)';
                    setTimeout(() => {
                        icon.style.transform = 'rotate(0deg)';
                    }, 500);
                }
            }
        };
        
        // 填充示例提示词（全局函数，供 onclick 调用）
        window.fillExample = function(text) {
            document.getElementById('promptInput').value = text;
        };

        // 生成 PPT（全局函数，供 onclick 调用）
        window.generatePPT = async function() {
            const prompt = document.getElementById('promptInput').value.trim();
            const slides = document.getElementById('slidesSelect').value;
            const style = document.getElementById('styleSelect').value;
            const audience = document.getElementById('audienceSelect').value;
            const customAudience = document.getElementById('customAudienceText').value.trim();
            
            if (!prompt) {
                // 显示错误消息
                const errorDiv = document.getElementById('promptError');
                if (errorDiv) {
                    errorDiv.classList.remove('hidden');
                }
                return;
            }
            
            // 清空错误消息（如果有）
            const errorDiv = document.getElementById('promptError');
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
            
            // 显示 Activity Timeline 面板（带动画）
            showTimelinePanel();
            
            // 构建完整的提示词
            let fullPrompt = prompt;
            
            // 添加页数
            fullPrompt += `, generate ${slides} slides`;
            
            // 添加样式
            const styleNames = {
                'professional': 'professional business style',
                'modern': 'modern minimalist style',
                'creative': 'creative artistic style',
                'academic': 'academic report style',
                'tech': 'tech-focused style',
                'elegant': 'elegant and fresh style'
            };
            fullPrompt += `, use ${styleNames[style]}`;
            
            // 添加目标人群
            const finalAudience = audience === 'custom' ? customAudience : audience;
            if (finalAudience) {
                fullPrompt += `, target audience: ${finalAudience}`;
            }
            
            // 禁用按钮
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtnText').textContent = 'Generating...';
            
            // 清空时间轴
            document.getElementById('timelineContainer').innerHTML = '<div class="text-center text-gray-400 text-sm py-8" id="emptyTimeline">No activity yet. Start generating to see progress.</div>';
            document.getElementById('downloadSection').classList.add('hidden');
            
            // 添加初始时间轴项
            addTimelineItem('progress', 'Starting', 'Creating task...', new Date().toISOString());
            
            try {
                let result;
                
                // 如果启用 Mock 模式，使用 Mock 响应
                if (USE_MOCK_DATA) {
                    console.log('[Mock] Creating task with prompt:', fullPrompt);
                    await new Promise(resolve => setTimeout(resolve, 500)); // 模拟 API 延迟
                    result = mockCreateTaskResponse;
                    console.log('[Mock] Task created:', result);
                } else {
                    // 创建任务（使用 V2 API，支持 Webhook）
                    const response = await fetch(`${API_BASE}/v2/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            prompt: fullPrompt,
                            client_id: clientId
                        })
                    });
                    
                    result = await response.json();
                }
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to create task');
                }
                
                currentTaskId = result.data.id;
                
                // 订阅任务更新（仅在真实 WebSocket 模式下）
                if (!USE_MOCK_DATA && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        action: 'subscribe',
                        task_id: currentTaskId
                    }));
                } else if (USE_MOCK_DATA) {
                    console.log('[Mock] 任务创建成功，taskId:', currentTaskId);
                    // 在 Mock 模式下，任务创建后启动消息序列
                    startMockWebSocket(currentTaskId);
                }
                
                addTimelineItem('progress', 'Task Created', `Task ID: ${currentTaskId.slice(0, 8)}...`, new Date().toISOString());
                
            } catch (error) {
                console.error('Error creating task:', error);
                addTimelineItem('error', 'Error', error.message || 'Failed to create task', new Date().toISOString());
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtnText').textContent = 'Retry';
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化示例提示词
            renderExamplePrompts();
            
            // 当用户输入 promptInput 时，清空错误消息
            const promptInput = document.getElementById('promptInput');
            if (promptInput) {
                promptInput.addEventListener('input', () => {
                    const errorDiv = document.getElementById('promptError');
                    if (errorDiv) {
                        errorDiv.classList.add('hidden');
                    }
                });
            }
            
            // 自定义人群选择
            document.getElementById('audienceSelect').addEventListener('change', (e) => {
                const customInput = document.getElementById('customAudienceInput');
                if (e.target.value === 'custom') {
                    customInput.classList.remove('hidden');
                } else {
                    customInput.classList.add('hidden');
                }
            });
            
            // 样式选择框图标更新
            const styleSelect = document.getElementById('styleSelect');
            updateStyleIcon(); // 初始化图标
            styleSelect.addEventListener('change', updateStyleIcon);
            
            // 初始化 WebSocket（根据 USE_MOCK_DATA 决定使用 mock 还是真实连接）
            if (USE_MOCK_DATA) {
                console.log('[App] 启用 Mock 模式 - 使用模拟数据');
                initMockWebSocket(); // 只初始化连接，不发送消息
            } else {
                console.log('[App] 使用真实 WebSocket 连接');
                initWebSocket();
            }
        });

        // 初始化 WebSocket 连接
        function initWebSocket() {
            clientId = `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}${APP_BASE}/ws/${clientId}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                updateWSStatus(true, 'Connected');
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateWSStatus(false, 'Connection error');
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateWSStatus(false, 'Disconnected');
                // 尝试重连
                if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
                wsReconnectTimer = setTimeout(() => {
                    initWebSocket();
                }, 3000);
            };
        }

        // 更新 WebSocket 状态显示
        function updateWSStatus(connected, text) {
            const indicator = document.getElementById('wsIndicator');
            const statusText = document.getElementById('wsStatusText');
            
            if (connected) {
                indicator.className = 'w-2 h-2 rounded-full bg-green-500';
            } else {
                indicator.className = 'w-2 h-2 rounded-full bg-red-500';
            }
            statusText.textContent = text;
        }

        // 处理 WebSocket 消息
        function handleWebSocketMessage(message) {
            console.log('WebSocket message:', message);
            
            switch (message.type) {
                case 'connected':
                    updateWSStatus(true, 'Connected');
                    break;
                    
                case 'task_update':
                case 'task_progress':
                    const progressMsg = message.data?.message || message.message || 'Processing...';
                    addTimelineItem('progress', 'Task Progress', progressMsg, message.timestamp);
                    break;
                    
                case 'task_created':
                    const createdMsg = message.message || `Task created: ${message.title || message.task_id || 'Task'}`;
                    addTimelineItem('progress', 'Task Created', createdMsg, message.timestamp);
                    if (message.task_id) {
                        currentTaskId = message.local_task_id || message.task_id;
                    }
                    break;
                    
                case 'task_completed':
                    // 先更新所有 progress 项为 completed，移除光影效果
                    updateTimelineItemStatus('completed');
                    const completedMsg = message.message || 'PPT generation completed successfully!';
                    addTimelineItem('completed', 'Task Completed', completedMsg, message.timestamp);
                    if (message.local_task_id) {
                        currentTaskId = message.local_task_id;
                    }
                    document.getElementById('downloadSection').classList.remove('hidden');
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('generateBtnText').textContent = 'Generate New PPT';
                    break;
                    
                case 'task_failed':
                    // 先更新所有 progress 项为 error，移除光影效果
                    updateTimelineItemStatus('error');
                    addTimelineItem('error', 'Task Failed', message.error || 'Task failed', message.timestamp);
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('generateBtnText').textContent = 'Retry';
                    break;
                    
                case 'pong':
                    // 心跳响应，忽略
                    break;
                    
                default:
                    console.log('Unknown message type:', message.type);
            }
        }

        // 移除所有 progress 项的光影效果（移除 active 类）
        function removeAllProgressEffects() {
            const container = document.getElementById('timelineContainer');
            const progressItems = container.querySelectorAll('.timeline-item.progress.active');
            progressItems.forEach(item => {
                item.classList.remove('active');
            });
        }
        
        // 更新时间轴项状态（从 progress 变为 completed 或 error，移除光影效果）
        function updateTimelineItemStatus(newType) {
            const container = document.getElementById('timelineContainer');
            const progressItems = container.querySelectorAll('.timeline-item.progress');
            
            progressItems.forEach(item => {
                // 移除 progress 类、active 类和相关动画
                item.classList.remove('progress', 'active');
                item.classList.add(newType);
                item.style.animation = 'none';
            });
        }
        
        // 添加时间轴项目
        function addTimelineItem(type, title, message, timestamp) {
            const container = document.getElementById('timelineContainer');
            const emptyMsg = document.getElementById('emptyTimeline');
            
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            // 如果新项是 progress，先移除之前所有 progress 项的光影效果
            if (type === 'progress') {
                removeAllProgressEffects();
            }
            
            // 如果新项是 completed 或 error，移除之前所有 progress 项的光影效果并更新状态
            if (type === 'completed' || type === 'error') {
                updateTimelineItemStatus(type);
            }
            
            const item = document.createElement('div');
            item.className = `timeline-item ${type}`;
            
            // 如果是 progress 类型，添加 active 类以显示光影效果
            if (type === 'progress') {
                item.classList.add('active');
            }
            
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            item.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-1">
                        <h4 class="text-sm font-semibold text-gray-900">${title}</h4>
                        <span class="text-xs text-gray-500">${time}</span>
                    </div>
                    <p class="text-xs text-gray-600">${message}</p>
                </div>
            `;
            
            container.appendChild(item);
            container.scrollTop = container.scrollHeight;
        }

        // 注意：fillExample 和 generatePPT 函数已在前面定义（第443-545行），这里不再重复定义
        
        // 下载 PPT（全局函数，供 onclick 调用）
        window.downloadPPT = function() {
            if (currentTaskId) {
                window.open(`${API_BASE}/tasks/${currentTaskId}/download`, '_blank');
            }
        }
    </script>
</body>
</html>
